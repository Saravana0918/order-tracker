<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Production Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body            { background:#f4f6f9; }
    .badge-pending  { background:#ffc107;color:#000;border-radius:50px;padding:.4em .8em; }
    .badge-done     { background:#198754;border-radius:50px;padding:.4em .8em; }
    .badge-assign   { background:#0d6efd;border-radius:50px;padding:.4em .8em; }
    .search-bar i   { position:absolute;top:50%;left:15px;transform:translateY(-50%);color:#aaa; }
    .search-bar input{ border-radius:50px;padding-left:35px; }
    .card           { border:none;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.05); }
    .btn-add        { border-radius:50px; }
    table.table-hover tbody tr.row-expired td {background-color: #f8d7da !important; color: #721c24 !important;}
    #homeBtn {position: fixed;bottom: 20px;right: 20px;z-index: 999;border-radius: 50px;padding: 10px 20px;display: none;}

    /* KPI cards */
    .kpi-card{
      display:flex; align-items:center; gap:12px;
      padding:14px 16px; border-radius:14px; background:#fff;
      box-shadow:0 6px 20px rgba(0,0,0,.06); border:1px solid #eef0f4;
      transition:.2s transform, .2s box-shadow;
    }
    .kpi-card:hover{ transform:translateY(-2px); box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .kpi-icon{
      width:44px; height:44px; display:grid; place-items:center;
      border-radius:12px; color:#fff; font-size:18px; flex:0 0 44px;
    }
    .kpi-meta small{ color:#6b7280; font-weight:600; letter-spacing:.2px; }
    .kpi-meta h4{ margin:0; font-weight:700; color:#111827;font-family: 'Google Sans', Roboto, Arial, sans-serif; }
    .kpi-today  .kpi-icon{ background:linear-gradient(135deg,#22c55e,#16a34a);}
    .kpi-yday   .kpi-icon{ background:linear-gradient(135deg,#f59e0b,#d97706);}
    .kpi-week   .kpi-icon{ background:linear-gradient(135deg,#6366f1,#4f46e5);}
    .kpi-month  .kpi-icon{ background:linear-gradient(135deg,#06b6d4,#0891b2);}

    /* Small visual for saved date */
    .date-saved { outline: 2px solid #19875466; border-radius: 6px; }
  </style>
</head>
<body class="p-4">
<div class="container-fluid">
  <!-- TOP BAR -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="fas fa-clipboard-list"></i> Order Production Tracker</h3>
    <div>
      <span>ðŸ‘¤ <b id="loggedUser"></b></span>
      <button class="btn btn-sm btn-primary ms-2" onclick="syncOrders()">Sync Orders</button>
      <button class="btn btn-sm btn-danger ms-2" onclick="logout()">Logout</button>
    </div>
  </div>  
  
  <!-- Search bar + order count -->
  <div class="d-flex justify-content-between align-items-center my-3">
    <h5 id="orderCountText" class="mb-0"></h5>
    <input type="text" id="searchInput" class="form-control w-25"
           placeholder="Search Order IDâ€¦" onkeyup="filterOrders()">
  </div>

  <!-- DAILY ORDER COUNTS (Only admin/customer) -->
  <div id="dailyStatsWrapper" style="display:none;">
    <div class="row g-3" id="dailyStats">
      <div class="col-6 col-md-3">
        <div class="kpi-card kpi-today">
          <div class="kpi-icon"><i class="fa-solid fa-calendar-day"></i></div>
          <div class="kpi-meta"><small>Today</small><h4 id="countToday">0</h4></div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="kpi-card kpi-yday">
          <div class="kpi-icon"><i class="fa-regular fa-calendar"></i></div>
          <div class="kpi-meta"><small>Yesterday</small><h4 id="countYday">0</h4></div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="kpi-card kpi-week">
          <div class="kpi-icon"><i class="fa-solid fa-chart-line"></i></div>
          <div class="kpi-meta"><small>Last 7 Days</small><h4 id="count7">0</h4></div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="kpi-card kpi-month">
          <div class="kpi-icon"><i class="fa-regular fa-calendar-days"></i></div>
          <div class="kpi-meta"><small>This Month</small><h4 id="countMonth">0</h4></div>
        </div>
      </div>
    </div>
  </div>

  <button class="btn btn-primary" id="homeBtn">Home</button>

  <div id="summaryBox" style="display: none; margin-bottom: 20px;margin-top: 20px;">
    <label><strong>Select Date:</strong></label>
    <input type="date" id="summaryDate">
    <button onclick="fetchSummary()">Get Summary</button>
    <div id="summaryResult" style="margin-top: 10px; font-weight: bold;"></div>
  </div>

  <div id="weeklyPerformanceCard" class="card p-3 my-3" style="display:none;">
    <h5>Users</h5>
    <div id="userButtons" class="d-flex flex-wrap gap-2"></div>
  </div>
  <div id="userOrdersContainer" class="mt-4"></div>

  <h4 class="mt-4 d-flex align-items-center justify-content-between">
    Weekly Pending Summary (Last 7 Days)
    <button class="btn btn-secondary btn-sm mb-2" onclick="loadWeeklyPendingTable()">Refresh</button>
  </h4>

  <div id="weekly-summary-container" class="table-responsive">
    <table class="table table-bordered text-center" id="weekly-summary-table">
      <thead>
        <tr id="weekly-summary-header"></tr>
      </thead>
      <tbody id="weekly-summary-body"></tbody>
    </table>
  </div>
  
<h4 class="mt-4 d-flex align-items-center justify-content-between">
  Dispatch Summary (Next 7 Days)
  <button class="btn btn-secondary btn-sm mb-2" onclick="loadDispatchUpcomingTable()">Refresh</button>
</h4>

<div class="table-responsive">
  <table class="table table-bordered text-center">
    <thead><tr id="dispatch-up-header"></tr></thead>
    <tbody id="dispatch-up-body"></tbody>
  </table>
</div>

<h4 class="mt-4 d-flex align-items-center justify-content-between">
  Dispatch Details (Next 7 Days)
  <button class="btn btn-secondary btn-sm mb-2" onclick="loadDispatchDetailsTable()">Refresh</button>
</h4>

<div class="table-responsive">
  <table class="table table-bordered text-center">
    <thead>
      <tr>
        <th>Date</th>
        <th>Order ID</th>
        <th>Quantity (Items)</th>
      </tr>
    </thead>
    <tbody id="dispatch-details-body"></tbody>
  </table>
</div>



  <!-- ORDER TABLE -->
  <div class="card p-3" id="mainTableSection">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr id="theadRow"></tr>
        </thead>
        <tbody id="ordersTable"></tbody>
      </table>
      <div class="text-muted small mt-2" id="orderCount"></div>
    </div>
  </div>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const stages = ['design','printing','fusing','stitching','shipping'];
const allCols = [
  "order-id", "customer", "design",
  "dispatch_date",
  "design_assignee", "design_preview",
  "printing", "fusing", "stitching", "shipping",
  "updated", "price", "fulfillment", "payment", "shiptype", "items", "tags", "address", "actions"
];

const roleCols = {
  admin:     ['order-id','customer','design','dispatch_date','design_assignee','design_preview','printing','fusing','stitching','shipping','updated','actions'],
  customer:  ['order-id','customer','design','dispatch_date','design_assignee','design_preview','printing','fusing','stitching','shipping','updated','actions'],
  design:    ['order-id','customer','design','dispatch_date','updated','actions'],
  printing:  ['order-id','customer','design_preview','dispatch_date','updated','actions'],
  fusing:    ['order-id','customer','design_preview','dispatch_date','updated','actions'],
  stitching: ['order-id','customer','design_preview','dispatch_date','updated','actions'],
  shipping:  ['order-id','customer','design_preview','dispatch_date','updated','actions']
};

let userRole='', username='';
let allOrders = [];
let filteredOrders = [];

const homeBtn = document.getElementById('homeBtn');

// Show button only when user scrolls a bit
window.addEventListener('scroll', () => {
  homeBtn.style.display = window.scrollY > 200 ? 'block' : 'none';
});

// Scroll to main table when clicked
homeBtn.addEventListener('click', () => {
  const tableSection = document.getElementById('mainTableSection');
  if (tableSection) tableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
});

function setAssigneeEnabled(orderId, enabled) {
  const sel = document.querySelector(`select[data-order-id="${orderId}"]`);
  const btn = document.querySelector(`button[data-assign-btn="${orderId}"]`);
  if (sel) sel.disabled = !enabled;
  if (btn) btn.disabled = !enabled;
}

function onDispatchChange(orderId) {
  const inp = document.querySelector(`input[data-dispatch-input="${orderId}"]`);
  setAssigneeEnabled(orderId, Boolean(inp && inp.value));
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Auth helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function logout(){ localStorage.clear(); location.href = '/login'; }
function checkLogin(){
  userRole = localStorage.getItem('role') || '';
  username = localStorage.getItem('username') || '';

  if(!username) location.href = '/login';
  document.getElementById('loggedUser').innerText = `${username} (${userRole})`;

  // Cards + weekly perf only for admin & customer
  const statsWrap = document.getElementById('dailyStatsWrapper');
  if (userRole === 'admin' || userRole === 'customer') {
    document.getElementById('weeklyPerformanceCard').style.display = 'block';
    if (statsWrap) statsWrap.style.display = 'block';
  } else {
    if (statsWrap) statsWrap.style.display = 'none';
  }
}

function parseDateString(dateStr) {
  return new Date(dateStr);
}

function isReadyForDesign(o) {
  // hide when BOTH are set
  return Boolean(o.dispatch_date) && Boolean(o.design_assignee);
}

function baseCustomerFilter(list) {
  // for customer: show only NOT-ready orders
  if (userRole === 'customer') return list.filter(o => !isReadyForDesign(o));
  return list;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Column visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function applyRoleVisibility(){
  const visible = roleCols[userRole] || allCols;
  allCols.forEach(col=>{
    const th  = document.querySelector(`th[data-column="${col}"]`);
    const tds = document.querySelectorAll(`td[data-column="${col}"]`);
    const dsp = visible.includes(col)?'':'none';
    if (th) th.style.display = dsp;
    tds.forEach(td=>td.style.display=dsp);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Date utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toInputDate(d){
  if(!d) return '';
  const x = new Date(d);
  const y = x.getFullYear();
  const m = String(x.getMonth()+1).padStart(2,'0');
  const dd = String(x.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ API: Save Dispatch Date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Save Dispatch Date (search-aware + customer auto-hide when both set)
async function saveDispatchDate(orderId){
  const inp = document.querySelector(`input[data-dispatch-input="${orderId}"]`);
  if(!inp) return alert('Date input not found for this row.');

  const date = (inp.value || '').trim();   // yyyy-mm-dd from <input type="date">
  if(!date){ alert('Please choose a dispatch date'); return; }

  const prevDisabled = inp.disabled; 
  inp.disabled = true;

  try{
    const res = await fetch('/api/set-dispatch-date', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ order_id: orderId, dispatch_date: date })
    });
    const d = await res.json();

    if (res.ok && (d.success || d.ok)) {
      // update local cache
      const idStr = String(orderId);
      allOrders = allOrders.map(o =>
        (String(o.order_id) === idStr || String(o.order_name) === idStr)
          ? { ...o, dispatch_date: date }
          : o
      );

      // recompute filtered view:
      // - if searching â†’ show matches from ALL orders (even hidden ones)
      // - else:
      //   * design_user â†’ only their orders
      //   * customer    â†’ hide orders that have BOTH date & assignee
      //   * others      â†’ show all
      const q = (document.getElementById('searchInput')?.value || '').trim();
      if (q) {
        filterOrders(); // your search already looks at allOrders
      } else {
        if (userRole && userRole.startsWith('design_user')) {
          filteredOrders = allOrders.filter(o => o.design_assignee === username);
        } else if (userRole === 'customer') {
          filteredOrders = allOrders.filter(o => !(o.dispatch_date && o.design_assignee));
        } else {
          filteredOrders = [...allOrders];
        }
        renderTable();
      }

      loadDispatchUpcomingTable();

      // visual cue
      inp.classList.add('date-saved');
      setTimeout(()=> inp.classList.remove('date-saved'), 1200);
    } else {
      alert(d?.error || 'Failed to save dispatch date');
    }
  } catch(e){
    console.error(e);
    alert('Network error while saving date');
  } finally{
    inp.disabled = prevDisabled;
  }
}



async function loadDispatchUpcomingTable() {
  try {
    const res = await fetch('/api/dispatch-summary-upcoming');
    const data = await res.json();
    if (!data?.length) return;

    const header = document.getElementById('dispatch-up-header');
    const body   = document.getElementById('dispatch-up-body');

    // Columns exactly like Weekly Summary
    const cols = [
      'date', 'srikanth', 'kushi', 'shravanthi', 'mahesh', 'pawan',
      'printing_user', 'fusing_user', 'stitching_user', 'shipping_user', 'total'
    ];

    header.innerHTML = cols.map(c => `<th>${c}</th>`).join('');
    body.innerHTML = '';

    data.forEach(r => {
      const tds = cols.map(k => `<td>${r[k] ?? 0}</td>`).join('');
      body.innerHTML += `<tr>${tds}</tr>`;
    });
  } catch (e) {
    console.error('loadDispatchUpcomingTable error:', e);
  }
}

// load on page load with others
document.addEventListener('DOMContentLoaded', () => {
  loadDispatchUpcomingTable();
  loadDispatchDetailsTable();
});

async function loadDispatchDetailsTable(){
  try{
    const res = await fetch('/api/dispatch-details-upcoming');
    const data = await res.json();
    const body = document.getElementById('dispatch-details-body');
    body.innerHTML = '';

    (data.rows || []).forEach(r => {
      body.innerHTML += `
        <tr>
          <td>${r.date}</td>
          <td>${r.order_name || r.order_id}</td>
          <td>${r.quantity ?? 0}</td>
        </tr>`;
    });
  } catch(e){
    console.error('loadDispatchDetailsTable error:', e);
  }
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fetch orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadOrders() {
  userRole = localStorage.getItem('role');
  username = localStorage.getItem('username');

  if (!username || !userRole) {
    alert('User session not found. Please log in again.');
    return;
  }

  const res = await fetch('/api/orders', {
    headers: { 'x-user-role': userRole, 'x-user-name': username }
  });
  const data = await res.json();
  allOrders = data.orders || [];

  if (userRole && userRole.startsWith('design_user')) {
  filteredOrders = allOrders.filter(o => o.design_assignee === username);
  } else {
    // ðŸ‘‡ customer hides â€œreadyâ€ orders by default
    filteredOrders = baseCustomerFilter(allOrders);
  }

  renderTable();

  // Only admin/customer see counts
  const statsWrap = document.getElementById('dailyStatsWrapper');
  if (userRole === 'admin' || userRole === 'customer') {
    if (statsWrap) statsWrap.style.display = 'block';
    renderDailyCounts(allOrders);
  } else if (statsWrap) {
    statsWrap.style.display = 'none';
  }
}

async function loadWeeklySummary() {
  try {
    const res = await fetch('/api/weekly-summary');
    const data = await res.json();
    if (!data || !data.users) return;

    const container = document.getElementById('userButtons');
    container.innerHTML = '';
    data.users.forEach(user => {
      const btn = document.createElement('button');
      btn.className = "btn btn-outline-primary btn-sm";
      btn.innerText = `${user.username} (${user.count})`;
      btn.onclick = () => showUserOrders(user.username);
      container.appendChild(btn);
    });
  } catch (err) {
    console.error('Failed to load weekly summary', err);
  }
}

// ------------------- Weekly Pending Table Loader -------------------
async function loadWeeklyPendingTable() {
  try {
    const res = await fetch('/api/weekly-summary-table');
    const data = await res.json();
    if (!data.length) return;

    const headerRow = document.getElementById('weekly-summary-header');
    const body = document.getElementById('weekly-summary-body');

    headerRow.innerHTML = '';
    body.innerHTML = '';

    const keys = Object.keys(data[0]); // e.g., ["date", "srikanth", ...]
    headerRow.innerHTML = `<th>Date</th>` + keys.slice(1).map(k => `<th>${k}</th>`).join('');

    data.forEach(row => {
      let rowHTML = `<td>${row.date}</td>`;
      keys.slice(1).forEach(k => { rowHTML += `<td>${row[k]}</td>`; });
      body.innerHTML += `<tr>${rowHTML}</tr>`;
    });
  } catch (err) {
    console.error('Error loading weekly pending table:', err);
  }
}
document.addEventListener('DOMContentLoaded', loadWeeklyPendingTable);

async function loadDispatchSummaryTable() {
  try {
    const res = await fetch('/api/dispatch-summary-totals');  // ðŸ‘ˆ new fast endpoint
    const data = await res.json();
    if (!Array.isArray(data) || !data.length) return;

    const headerRow = document.getElementById('dispatch-summary-header');
    const body      = document.getElementById('dispatch-summary-body');

    headerRow.innerHTML = `<th>Date</th><th>Total</th>`;
    body.innerHTML = '';

    for (const r of data) {
      body.innerHTML += `<tr><td>${r.date}</td><td>${r.total}</td></tr>`;
    }
  } catch (e) {
    console.error('Error loading dispatch summary:', e);
  }
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Show User Orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function showUserOrders(username) {
  const container = document.getElementById('userOrdersContainer');
  container.innerHTML = `<p>Loading orders for <b>${username}</b>...</p>`;

  const res = await fetch(`/api/user-orders/${username}`);
  const data = await res.json();

  if (!data.orders.length) {
    container.innerHTML = `<p>No pending orders for <b>${username}</b>.</p>`;
    return;
  }

  let table = `
    <h5>Orders for ${username}</h5>
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Status</th>
          <th>Updated At</th>
        </tr>
      </thead>
      <tbody>
  `;
  const now = new Date();

  data.orders.forEach(o => {
    const updated = new Date(o.updated_at);
    const diffHours = (now - updated) / (1000 * 60 * 60);
    const expiredClass = diffHours > 48 ? 'row-expired' : '';

    const statusBadge = o.status === 'Done'
      ? '<span class="badge bg-success">Done</span>'
      : '<span class="badge bg-warning text-dark">Pending</span>';

    table += `
      <tr class="${expiredClass}">
        <td>${o.order_name || o.order_id}</td>
        <td>${o.customer_name}</td>
        <td>${statusBadge}</td>
        <td>${updated.toLocaleString()}</td>
      </tr>`;
  });

  table += `</tbody></table>`;
  container.innerHTML = table;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Search filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function filterOrders(){

  const q = document.getElementById('searchInput').value.trim().toLowerCase();

  if (!q) {
    // no query â†’ apply base (role-aware) filter
    if (userRole && userRole.startsWith('design_user')) {
      filteredOrders = allOrders.filter(o => o.design_assignee === username);
    } else {
      filteredOrders = baseCustomerFilter(allOrders);
    }
  } else {
    // query present â†’ search across ALL orders (even hidden ones)
    filteredOrders = allOrders.filter(o=>{
      const oid = (o.order_name || o.order_id || '').toString().toLowerCase();
      return oid.includes(q);
    });
  }

  renderTable();
  
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ Daily Counts â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDailyCounts(orders){
  const dayKeyLocal = (d) => {
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth() + 1).padStart(2, '0');
    const dd = String(x.getDate()).padStart(2, '0');
    return `${y}-${m}-${dd}`;
  };

  const today = new Date();
  const todayStr = dayKeyLocal(today);

  const byDay = {};
  for (const o of orders){
    const d = o.created_at || o.createdAt || o.updated_at;
    if (!d) continue;
    const key = dayKeyLocal(d);
    byDay[key] = (byDay[key] || 0) + 1;
  }

  const cToday = byDay[todayStr] || 0;

  const y = new Date(today); y.setDate(y.getDate()-1);
  const cYday = byDay[dayKeyLocal(y)] || 0; 

  let c7 = 0;
  for (let i=0;i<7;i++){
    const d = new Date(today); d.setDate(d.getDate()-i);
    c7 += (byDay[dayKeyLocal(d)] || 0);
  }

  const mStart = new Date(today.getFullYear(), today.getMonth(), 1);
  let cMonth = 0;
  Object.keys(byDay).forEach(k=>{
    const kd = new Date(k);
    if (kd >= mStart && kd <= today) cMonth += byDay[k];
  });

  const tEl = document.getElementById('countToday');
  if (!tEl) return;

  tEl.textContent = cToday;
  document.getElementById('countYday').textContent  = cYday;
  document.getElementById('count7').textContent     = c7;
  document.getElementById('countMonth').textContent = cMonth;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Assign designer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// Assign / Reassign Designer (instant UI + customer auto-hide + search-aware)
async function assignDesigner(orderId){
  const select   = document.querySelector(`select[data-order-id="${orderId}"]`);
  const designer = select?.value;
  if(!designer){ alert("Pick a designer first"); return; }

  const res  = await fetch('/api/assign-designer', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ order_id: orderId, designer })
  });
  const data = await res.json();

  if (res.ok && data.success){
    alert('Assigned successfully!');

    // update local cache (no full reload)
    const idStr = String(orderId);
    allOrders = allOrders.map(o =>
      (String(o.order_id) === idStr || String(o.order_name) === idStr)
        ? { ...o, design_assignee: designer }
        : o
    );

    // same recompute rules as saveDispatchDate()
    const q = (document.getElementById('searchInput')?.value || '').trim();
    if (q) {
      filterOrders();
    } else {
      if (userRole && userRole.startsWith('design_user')) {
        filteredOrders = allOrders.filter(o => o.design_assignee === username);
      } else if (userRole === 'customer') {
        filteredOrders = allOrders.filter(o => !(o.dispatch_date && o.design_assignee));
      } else {
        filteredOrders = [...allOrders];
      }
      renderTable();
    }

    loadDispatchUpcomingTable();
    loadDispatchDetailsTable();
  } else {
    alert(data?.error || 'Assignment failed');
  }
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Preview & upload helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function preview(id){
  const inp = document.getElementById(`file-${id}`);
  const img = document.getElementById(`thumb-${id}`);
  if (inp.files[0]){ img.src = URL.createObjectURL(inp.files[0]); img.style.display='block'; }
}
async function uploadThenDone(orderId){
  const file = document.getElementById(`file-${orderId}`).files[0];
  if (!file) return alert('Choose file first.');
  const formData = new FormData(); formData.append('image',file); formData.append('orderId',orderId);
  const res = await fetch('/api/upload-design',{method:'POST',body:formData});
  const d   = await res.json();
  if(d.success){ alert('Uploaded!'); await loadOrders(); } else alert('Upload failed');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Quick done for later stages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function quickDone(orderId) {
  if (!confirm("Are you sure you want to mark this stage as DONE?")) return;

  const res = await fetch('/api/mark-stage-done', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ orderId, stage: userRole })
  });

  const data = await res.json();
  if (data.success) {
    alert('Marked as Done!');
    await loadOrders();
    loadDispatchUpcomingTable();
  } else {
    alert('Failed to update. Please try again.');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const role = localStorage.getItem('role');
  if (role === 'admin' || role === 'customer') {
    document.getElementById('summaryBox').style.display = 'block';
  }
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fetch summary (existing) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchSummary() {
  const date = document.getElementById('summaryDate').value;
  if (!date) return alert('Please select a date.');

  const res = await fetch('/api/pending-summary', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ date })
  });

  const data = await res.json();
  if (data.error) { alert('Error fetching summary.'); return; }

  const design = Number(data.design_pending);
  const printing = Number(data.printing_pending);
  const fusing = Number(data.fusing_pending);
  const stitching = Number(data.stitching_pending);
  const shipping = Number(data.shipping_pending);
  const total = design + printing + fusing + stitching + shipping;

  document.getElementById('summaryResult').innerText =
    `Design: ${design}, Printing: ${printing}, Fusing: ${fusing}, Stitching: ${stitching}, Shipping: ${shipping}, Total: ${total}`;
}

function getStatusBadge(value) {
  return value == 1
    ? '<span class="badge bg-success">Done</span>'
    : '<span class="badge bg-warning text-dark">Pending</span>';
}

async function syncOrders() {
  if (!confirm('Do you want to fetch the latest orders from Shopify?')) return;

  const btn = event.target;
  btn.disabled = true;
  btn.innerText = 'Syncing...';

  try {
    const res = await fetch('/api/sync-orders', { method: 'POST' });
    const data = await res.json();

    if (data.success) {
      alert(`Orders synced successfully! ${data.imported} new orders added/updated.`);
      await loadOrders();
    } else {
      alert('Failed to sync orders: ' + (data.error || 'Unknown error'));
    }
  } catch (err) {
    console.error(err);
    alert('Sync failed, please try again.');
  } finally {
    btn.disabled = false;
    btn.innerText = 'Sync Orders';
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Render table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderTable(){
  const tbody = document.getElementById('ordersTable');
  const thead = document.getElementById('theadRow');
  tbody.innerHTML = ''; thead.innerHTML = '';

  const visible = roleCols[userRole] || allCols;
  const now = new Date();

  // Header
  visible.forEach(col=>{
    const th=document.createElement('th');
    th.setAttribute('data-column',col);
    th.innerText = col.replace(/_/g,' ').replace('-',' ').toUpperCase();
    thead.appendChild(th);
  });

  // Rows
  filteredOrders.forEach(r=>{
    const tr=document.createElement('tr'); 
    let html='';

    const updatedTime = parseDateString(r.created_at);
    const diffHours = (now - updatedTime) / (1000 * 60 * 60);
    if (diffHours > 48) tr.classList.add('row-expired');

    visible.forEach(col=>{
      let value='-';

      if (col==='order-id') {
        value = r.order_name || r.order_id;
      }
      else if (col==='customer') {
        value = r.customer_name || '-';
      }
      else if (stages.includes(col)) {
        value = getStatusBadge(r[col + '_done']);
      }

      // --- Dispatch date BEFORE assignee; date change enables assignee
      else if (col === 'dispatch_date') {
        const current = toInputDate(r.dispatch_date);
        if (userRole === 'admin' || userRole === 'customer'){
          const minDate = toInputDate(new Date());
          value = `
            <div class="d-flex align-items-center gap-1">
              <input type="date"
                     class="form-control form-control-sm"
                     data-dispatch-input="${r.order_id}"
                     value="${current}"
                     min="${minDate}"
                     onchange="onDispatchChange('${r.order_id}')">
              <button class="btn btn-sm btn-outline-primary"
                      onclick="saveDispatchDate('${r.order_id}')">Save</button>
            </div>`;
        } else {
          value = current || '-';
        }
      }

      // --- Design assignee (disabled until date set)
      else if (col==='design_assignee'){
        if (userRole==='admin' || userRole==='customer'){
          const hasDate = Boolean(r.dispatch_date);
          value = `
            <div class="d-flex align-items-center gap-1">
              <select class="form-select form-select-sm"
                      data-order-id="${r.order_id}"
                      ${hasDate ? '' : 'disabled'}
                      title="${hasDate ? '' : 'Set dispatch date first'}">
                <option value="">${r.design_assignee ? r.design_assignee : 'Assignâ€¦'}</option>
                <option value="srikanth">Srikanth</option>
                <option value="kushi">Kushi</option>
                <option value="shravanthi">Shravanthi</option>
                <option value="mahesh">Mahesh</option>
                <option value="pawan">Pawan</option>
              </select>
              <button class="btn btn-sm btn-primary"
                      data-assign-btn="${r.order_id}"
                      ${hasDate ? '' : 'disabled'}
                      onclick="assignDesigner('${r.order_id}')">
                ${r.design_assignee ? 'Reassign' : 'Assign'}
              </button>
            </div>`;
        } else {
          value = r.design_assignee ? `<span class="badge badge-assign">${r.design_assignee}</span>` : '-';
        }
      }

      else if (col==='design_preview'){
        value = r.design_image
          ? `<img src="/uploads/design/${r.design_image}" style="max-width:90px;border:1px solid #ccc;cursor:pointer"
                 title="Click to enlarge" onclick="window.open('/uploads/design/${r.design_image}','_blank')">`
          : '-';
      }

      else if (col==='updated') {
        value = new Date(r.created_at).toLocaleString();
      }

      else if (col==='actions'){
        if (userRole.startsWith('design') && !r.design_done && r.design_assignee===username){
          value=`
            <div class="d-flex flex-column gap-1">
              <input type="file" id="file-${r.order_id}" class="form-control form-control-sm"
                     accept="image/*" onchange="preview('${r.order_id}')">
              <img id="thumb-${r.order_id}" style="max-width:90px;display:none;border:1px solid #ccc">
              <button class="btn btn-sm btn-success mt-1" onclick="uploadThenDone('${r.order_id}')">
                Upload & Done
              </button>
            </div>`;
        } else if(
          (userRole==='printing'  && !r.printing_done) ||
          (userRole==='fusing'    && !r.fusing_done)   ||
          (userRole==='stitching' && !r.stitching_done)||
          (userRole==='shipping'  && !r.shipping_done)
        ){
          value=`
            <button class="btn btn-sm btn-success" onclick="quickDone('${r.order_id}')">
              Mark as Done
            </button>`;
        }
      }

      else {
        value = r[col] ?? '-';
      }

      html += `<td data-column="${col}">${value}</td>`;
    });

    tr.innerHTML = html;
    tbody.appendChild(tr);
  });

  document.getElementById('orderCountText').innerText =
    `Showing ${filteredOrders.length} orders`;

  applyRoleVisibility();
}


window.onload = async () => {
  checkLogin();
  await loadOrders();
  if (userRole === 'admin' || userRole === 'customer') {
    await loadWeeklySummary();
  }
};
</script>
</body>
</html>
